<!DOCTYPE html>
<html>

<head>



    <title>Directory - Troop 485</title>

    <script src="/js/combined.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/3.9.0/firebase.js"></script>

    <script>
        // Initialize Firebase
        var config = {
            apiKey: "AIzaSyAvhRMDTAxHRqIM0-RpHxPjZtMn7S_H7K4",
            authDomain: "t485.firebaseapp.com",
            databaseURL: "https://t485.firebaseio.com",
            storageBucket: "project-2556333409340273878.appspot.com",
            messagingSenderId: "510743665020"
        };
        firebase.initializeApp(config);
    </script>
    <script src="/js/t485.js"></script>


    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/t485.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Josefin+Slab:100,300,400,600,700,100italic,300italic,400italic,600italic,700italic">

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Join Troop 485 in Cupertino to experience an excellent Scouting experience">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <meta name="google-signin-client_id" content="154157170484-81ud6v3rfber96pekq75q86igmf1fsif.apps.googleusercontent.com">

    <!-- Favicons -->
    <link rel="apple-touch-icon" sizes="152x152" href="favicons/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="favicons/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" href="favicons/favicon-16x16.png" sizes="16x16">

    <link rel="manifest" href="/manifest.json">

    <script>
        try {
            localStorage.setItem('foo', 'bar');
        }
        catch (e) {
            if (e.message === 'The quota has been exceeded.') {
                // using Safari(desktop & iOS) or Chrome(iOS) w/ private, localStorage not supported
                // firebase will throw error, so better to alert user now
                alert('Private browsing is not supported!');
            }
            throw '';
        }
    </script>

</head>

<body><img src="/img/header.gif" id="header" alt="Troop 485 banner" width="990" height="151">

    <!-- Navigation -->
    <nav class="navbar navbar-default">
        <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
                <!-- navbar-brand is hidden on larger screens, but visible when the menu is collapsed -->
                <a class="navbar-brand" href="/">T485</a>
            </div>
            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav">
                    <li>
                        <a href="/">Home</a>
                    </li>
                    <li>
                        <a href="/calendar.html">Calendar</a>
                    </li>
                    <li>
                        <a href="/directory.html">Directory </a>
                    </li>

                    <li>
                        <a href="/new-scout.html">New Scouts</a>
                    </li>

                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
                        Resources <span class="caret"></span>
                    </a>
                        <ul class="dropdown-menu">
                            <li><a href="/resources/files.html">Files</a></li>
                            <li><a href="/resources/event-pages.html">Event Pages</a></li>
                            <li><a href="/resources/meeting-minutes.html">Meeting Minutes/Reflections</a></li>
                            <li><a href="/resources/pictures.html">Pictures</a></li>
                            <li><a href="/resources/app-download.html">Download App</a></li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
                        About <span class="caret"></span>
                    </a>
                        <ul class="dropdown-menu">
                            <li><a href="/about/faq.html">FAQ</a></li>
                            <li><a href="/about/merit-badges.html">Merit Badges</a></li>
                            <li><a href="/about/eagle.html">Path to Eagle</a></li>
                            <li><a href="/about/smc.html">SMC &amp; BOR</a></li>
                            <li><a href="/about/plc.html">PLC</a></li>
                            <li><a href="/about/troop-info.html">Troop Information</a></li>
                        </ul>
                    </li>
                    <li id="nav-user-status"><a onclick="window.location.href = '/logout.html?redir=' + encodeURIComponent(window.location.pathname);">Logout</a></li>

                </ul>

            </div>
        </div>
    </nav>
    <div id="alertBox"></div>

    <a id="toTop" onclick="window.location.hash='#'"></a>
    <p id="loading">Loading...</p>
    <div class="container hidden" id="login">

        <div class="row">
            <div class="box col-xs-12">
                <hr>
                <h2 class="intro-text text-center">Login to continue</h2>
                <hr>
                <p>
                    <a class="btn btn-block btn-social btn-google no-fancy-link" onclick="window.location.href = '/login.html?redir=' + encodeURIComponent(window.location.pathname)">
                        <span class="fa fa-google"></span> Sign in with Google
                    </a>
                </p>
            </div>
        </div>
    </div>
    <div class="container hidden" id="content">

        <div class="row" id="search">
            <div class="box col-xs-12">
                <hr>
                <h2 class="intro-text text-center">Search Directory</h2>
                <hr>
                <p>Click on the name for more information.</p>
                <div class="input-group col-xs-12">
                    <input type="text" id="search-query" class="form-control" placeholder="Type a name...">
                    <span class="input-group-btn" style="vertical-align: top">
                        <button class="btn btn-default" type="button" id="search-btn">
                            <i class="glyphicon glyphicon-search"></i>
                        </button>
                    </span>
                </div>
                <p style="display: none" id="loading">Loading...</p>
                <table class="table" id="results" style="display: none;">
                    <thead>
                        <tr>
                            <th class="col-xs-1">Name</th>
                            <th class="col-xs-1">Cell Phone</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <p id="no-result" style="display: none;"></p>
                <div id="detail" style="display: none;"></div>
            </div>
        </div>

        <div class="row" id="spreadsheet-confirm">
            <div class="box">
                <button type="button" id="spreadsheet-confirm-btn" class="btn btn-default">Show patrol spreadsheets</button>
            </div>
        </div>

        <div class="row" id="spreadsheet" style="display: none;">
            <div class="box">
                <ul class="nav nav-tabs no-fancy-navbar">
                    <li class="active"><a data-toggle="tab" href="#cacti">Cacti</a></li>
                    <li><a data-toggle="tab" href="#wildcats">Wildcats</a></li>
                    <li><a data-toggle="tab" href="#hawks">Hawks</a></li>
                    <li><a data-toggle="tab" href="#serpents">Serpents</a></li>
                    <li><a data-toggle="tab" href="#blobfish">Blobfish</a></li>
                    <li><a data-toggle="tab" href="#dragons">Dragons</a></li>
                </ul>

                <div class="tab-content" id="spreadsheet-content"></div>
            </div>
        </div>


        <script src="//static.getclicky.com/js" type="text/javascript"></script>
        <script type="text/javascript">
            try {
                clicky.init(101023955);
            }
            catch (e) {}
        </script>
        <noscript><p><img alt="Clicky" width="1" height="1" src="//in.getclicky.com/101023955ns.gif" /></p></noscript>

    </div>
    <!-- /.container -->
    <footer>
        <div class="container">
            <div class="box">
                <div class="col-lg-12 text-center">
                    <p>Copyright &copy; 2006-2017 Troop 485, Silicon Valley Monterey Bay Council, Boy Scouts of America.</p>

                </div>
            </div>
        </div>
    </footer>



    <script src="js/sjcl.min.js"></script>
    <script src="js/tabletop.min.js"></script>
    <!--authentication checkpoint -->
    <script>
        $("#loading").addClass("hidden");
        auth(() => $("#content").removeClass("hidden"), () => $("#login").removeClass("hidden"));
    </script>
    <script>
        /* global Tabletop $ auth sjcl getQuery history compare*/


        auth(() => {
            let text = '{"iv":"u94eK78S4EOGQqpYNDLrGw==","v":1,"iter":1000,"ks":128,"ts":64,"mode":"ccm","adata":"","cipher":"aes","salt":"g17ODbhwHcY=","ct":"66YjjNZp1zkWyBjPUD4XTHy2aHx8v2wPxywiPhbCxjCF8YWkhLzYnVgojeMZV2zbuQHjmrRLVbR+DTdeJzy0Xv70w1ez/eX4uX5nfiBCzi2kO4NwSLXUvJiIcuPGL7BLnXXXw893c0ADbqJUj6fS2nCfi0n9BT' +
                'koU9U8fDNXrsnRUkD0Oqd7khInVvOBoa4c1hjGx1P8cI3WXn29l0ezln2GPH1xqDenWQJTC+tAZ12a2e0uIb+zHIHJkTtjiZPGPBlZDe5/mFeqzr3e6qvZyawlOyI+NlrlQ3a10txli8P9M65UgfPhRDSMdGmeTuhiYkOhvUayWXg/DqMzabBem7cBcflxl8EzNuneoQ43E3ACqr/PdWyC5FBeNKTktyUQR6ypHQIWQwng0d5D7N9ZdfhGTzBDr3IYFaczaBATUuTnlMnBvhF/Jxvs5Rf8uiobblIrP1J25p9kzLe8acU="}';
            let secretInfo = JSON.parse(sjcl.decrypt('XH7uDeHIOFaJvizWBhA', text));


            $('#search-query').focus();

            $('#spreadsheet-confirm-btn').click(() => {
                $('#spreadsheet-confirm').hide();
                $('#spreadsheet-content').html(
                    '<div id="cacti" class="tab-pane fade in active">' +
                    '<a href="https://docs.google.com/spreadsheets/d/' + secretInfo.cacti + '/edit?usp=drive_web" target="_blank">Edit Spreadsheet</a>' +
                    '<iframe src="https://docs.google.com/spreadsheets/d/' + secretInfo.cacti + '/pubhtml?widget=true&amp;headers=false"></iframe>' +
                    '</div>' +
                    '<div id="hawks" class="tab-pane fade">' +
                    '<a href="https://docs.google.com/spreadsheets/d/' + secretInfo.hawks + '/edit?usp=drive_web" target="_blank">Edit Spreadsheet</a>' +
                    '<iframe src="https://docs.google.com/spreadsheets/d/' + secretInfo.hawks + '/pubhtml?widget=true&amp;headers=false"></iframe>' +
                    '</div>' +
                    '<div id="wildcats" class="tab-pane fade">' +
                    '<a href="https://docs.google.com/spreadsheets/d/' + secretInfo.wildcats + '/edit?usp=drive_web" target="_blank">Edit Spreadsheet</a>' +
                    '<iframe src="https://docs.google.com/spreadsheets/d/' + secretInfo.wildcats + '/pubhtml?widget=true&amp;headers=false"></iframe>' +
                    '</div>' +
                    '<div id="serpents" class="tab-pane fade">' +
                    '<a href="https://docs.google.com/spreadsheets/d/' + secretInfo.serpents + '/edit?usp=drive_web" target="_blank">Edit Spreadsheet</a>' +
                    '<iframe src="https://docs.google.com/spreadsheets/d/' + secretInfo.serpents + '/pubhtml?widget=true&amp;headers=false"></iframe>' +
                    '</div>' +
                    '<div id="blobfish" class="tab-pane fade">' +
                    '<a href="https://docs.google.com/spreadsheets/d/' + secretInfo.blobfish + '/edit?usp=drive_web" target="_blank">Edit Spreadsheet</a>' +
                    '<iframe src="https://docs.google.com/spreadsheets/d/' + secretInfo.blobfish + '/pubhtml?widget=true&amp;headers=false"></iframe>' +
                    '</div>' +
                    '<div id="dragons" class="tab-pane fade">' +
                    '<a href="https://docs.google.com/spreadsheets/d/' + secretInfo.dragons + '/edit?usp=drive_web" target="_blank">Edit Spreadsheet</a>' +
                    '<iframe src="https://docs.google.com/spreadsheets/d/' + secretInfo.dragons + '/pubhtml?widget=true&amp;headers=false"></iframe>' +
                    '</div>'
                );
                $('#spreadsheet').show();
            });


            // Cacti
            Tabletop.init({
                key: secretInfo.cacti,
                callback: data => {
                    data.forEach(curData => {
                        curData.patrol = 'Cacti';
                    });
                    window.globalData = window.globalData.concat(data);
                    alphabetize();
                },
                simpleSheet: true
            });

            // Hawks
            Tabletop.init({
                key: secretInfo.hawks,
                callback: data => {
                    data.forEach(curData => {
                        curData.patrol = 'Hawks';
                    });
                    window.globalData = window.globalData.concat(data);
                    alphabetize();
                },
                simpleSheet: true
            });

            // Wildcats
            Tabletop.init({
                key: secretInfo.wildcats,
                callback: data => {
                    data = data.Sheet1.elements;
                    data.forEach(curData => {
                        curData.patrol = 'Wildcats';
                    });
                    window.globalData = window.globalData.concat(data);
                    alphabetize();
                },
                simpleSheet: false
            }); // has 3 sheets, so only use 1st one

            // Serpents
            Tabletop.init({
                key: secretInfo.serpents,
                callback: data => {
                    data.forEach(curData => {
                        curData.patrol = 'Serpents';
                    });
                    window.globalData = window.globalData.concat(data);
                    alphabetize();
                },
                simpleSheet: true
            });

            // Blobfish
            Tabletop.init({
                key: secretInfo.blobfish,
                callback: data => {
                    data = data.Sheet1.elements;
                    data.forEach(curData => {
                        curData.patrol = 'Blobfish';
                    });
                    window.globalData = window.globalData.concat(data);
                    alphabetize();
                },
                simpleSheet: false
            }); // has 2 sheets, so only use 1st one

            // Dragons
            Tabletop.init({
                key: secretInfo.dragons,
                callback: data => {
                    data.forEach(curData => {
                        curData.patrol = 'Dragons';
                    });
                    window.globalData = window.globalData.concat(data);
                    alphabetize();
                },
                simpleSheet: true
            });

            function alphabetize() {
                window.globalData.sort((a, b) => {
                    if (a['Scout\'s Full Name (last name first):'] < b['Scout\'s Full Name (last name first):']) return -1;
                    if (a['Scout\'s Full Name (last name first):'] > b['Scout\'s Full Name (last name first):']) return 1;
                    return 0;
                });
            }
        }, null /*something should have already happened above*/ );



        window.globalData = [];
        $(document).ready(() => {
            $('#password').focus();
        });



        $('#search-query').keypress(function(e) {
            if (e.keyCode === 13) {
                $('#search-btn').click();
            }
        });


        $('#search-btn').click(() => {
            window.userquery = $("#search-query").val();

            updateURLQuery("?type=list&query=" + encodeURIComponent(window.userquery));
            showSearchResults(window.userquery);

        });

        if (getQuery("type") === "list" && getQuery("query") !== null && getQuery("query") !== "") {
            $("#loading").show();
            setTimeout(() => {
                $("#search-query").val(getQuery("query"));
                showSearchResults(getQuery("query"));
                $("#loading").hide();
            }, 1500);

        }
        else if (getQuery("type") === "profile" && getQuery("id") !== null && getQuery("id") !== "") {
            $("#loading").show();
            setTimeout(() => {
                showfullinfo(parseInt(getQuery("id"), 10), false);
                $("#loading").hide();
            }, 1500);
        }

        function updateURLQuery(query) {
            if (history.pushState) {
                var newurl = window.location.protocol + "//" + window.location.host + window.location.pathname + query;
                window.history.pushState({
                    path: newurl
                }, '', newurl);
            }
            else {
                window.location.href = window.location.protocol + "//" + window.location.host + window.location.pathname + query;

            }
        }

        function showSearchResults(userquery) {
            if (userquery === '') return;


            userquery = userquery.toLowerCase();
            //console.log(userquery);
            let query = [];

            if (userquery.search(' ') > 0) {
                query = userquery.split(' ');
            }
            else {
                query[0] = userquery;
                query[1] = null;
                // If more than one space use only first 2
                if (query[2] !== undefined) query = query.splice(0, 2);
            }
            if (query[1] === '') query[1] = null;

            //console.log(window.globalData);
            //console.log(query);

            // Split the names into first and last names
            let patrolnames = [];
            for (let curGlobalData of window.globalData) {
                let fullname = curGlobalData['Scout\'s Full Name (last name first):'].trim();
                let name = [];
                if ((fullname.match(/\s/g) || []).length === 2) {
                    // has middle name
                    let temp = fullname.split(' ');
                    name[0] = temp[2];
                    name[1] = temp[0].slice(0, -1);
                }
                else if (fullname.search(', ') > 0) {
                    name = fullname.split(', ');
                    let temp = name[0];
                    name[0] = name[1];
                    name[1] = temp;
                }
                else if ((fullname.match(/\s/g) || []).length === 1) {
                    name = fullname.split(' ');
                }
                else if (fullname.search(',') > 0) {
                    name = fullname.split(',');
                    let temp = name[0];
                    name[0] = name[1];
                    name[1] = temp;
                }
                else {
                    name = 'ERROR';
                    console.error('Unable to split given full name into first and last name');
                }
                name[0] = name[0].toLowerCase();
                name[1] = name[1].toLowerCase();
                patrolnames.push(name);
            }
            //console.log(patrolnames);

            // Search for patrolnames for query
            let results = [];
            // score lower is better
            let score = [];
            for (let i = 0; i < patrolnames.length; i++) {
                // Only first/last name
                if (query[1] === null) {
                    if (patrolnames[i][0] === query[0] || patrolnames[i][1] === query[0]) {
                        score.push({
                            id: i,
                            score: 0
                        });
                    }
                    else {
                        let diff = compare(query[0], patrolnames[i][0]) < compare(query[0], patrolnames[i][1]) ?
                            compare(query[0], patrolnames[i][0]) : compare(query[0], patrolnames[i][1]);
                        if (diff < query[0].length / 2) {
                            score.push({
                                id: i,
                                score: diff + 1
                            });
                        }
                    }
                    // If direct match set score to 0
                }
                else if (patrolnames[i][0] === query[0] && patrolnames[i][1] === query[1]) {
                    score.push({
                        id: i,
                        score: 0
                    });
                    break;
                    // First and last name
                }
                else {
                    let diff = compare(query[0], patrolnames[i][0]) + compare(query[1], patrolnames[i][1]);
                    if (diff < (query[0].length + query[1].length) / 2) {
                        score.push({
                            id: i,
                            score: diff + 1
                        });
                    }
                }
            }
            score.sort((a, b) => {
                return parseFloat(a.score) - parseFloat(b.score);
            });

            // Make sure scores list has items
            if (score[0]) {
                let firstScore = score[0].score;
                for (let i = 0; i < score.length; i++) {
                    // If direct match of query
                    if (score[i].score === firstScore) {
                        results.push(score[i].id);
                    }
                    else if (score[i].score !== firstScore) {
                        break;
                        // Otherwise display up to 3 names
                    }
                    else if (i < 3) {
                        results.push(score[i].id);
                    }
                }
            }

            //console.log(window.globalData);


            // Display search results
            $('#detail').hide();

            $('#results').hide();
            if (results.length === 0) {
                $('#no-result').html('Your search - <b>' + userquery + '</b> - did not match any names.');
                $('#no-result').show();
            }
            else {
                $('#no-result').hide();
                $('#results > tbody').html('');
                for (let result of results) {
                    let name = window.globalData[result]['Scout\'s Full Name (last name first):'];
                    $('#results > tbody').append(`
                        <tr>
                            <td><a onclick="showfullinfo(${result})">${name}</a></td>
                            <td>${window.globalData[result]['Scout\'s Cell Phone']}</td>
                        </tr>
                    `);
                }
                $('#results').show();
            }
        }

        function showfullinfo(id, updateQuery) {
            if (updateQuery !== false) {
                updateURLQuery("?type=profile&id=" + encodeURIComponent(id));
            }
            $('#results').hide();
            $('#detail').show().html('').append(`
                <br>
                Name:                               ${window.globalData[id]['Scout\'s Full Name (last name first):']}<br>
                Email: <a href="mailto:             ${window.globalData[id]['Scout\'s E-mail:']}">     ${window.globalData[id]['Scout\'s E-mail:']}</a><br>
                Cell Phone: <a href="tel:           ${window.globalData[id]['Scout\'s Cell Phone']}">  ${window.globalData[id]['Scout\'s Cell Phone']}</a><br>
                Home Phone: <a href="tel:           ${window.globalData[id]['Scout\'s Home Phone']}">  ${window.globalData[id]['Scout\'s Home Phone']}</a><br>
                Patrol:                             ${window.globalData[id].patrol}<br><br>
                Father\'s Cell Phone: <a href="tel: ${window.globalData[id]['Father\'s Cell Phone']}"> ${window.globalData[id]['Father\'s Cell Phone']}</a><br>
                Father\'s E-mail: <a href="mailto:  ${window.globalData[id]['Father\'s E-mail']}">     ${window.globalData[id]['Father\'s E-mail']}</a><br>
                Mother\'s Cell Phone: <a href="tel: ${window.globalData[id]['Mother\'s Cell Phone']}"> ${window.globalData[id]['Mother\'s Cell Phone']}</a><br>
                Mother\'s E-mail: <a href="mailto:  ${window.globalData[id]['Mother\'s E-mail']}">     ${window.globalData[id]['Mother\'s E-mail']}</a><br>
            `);
        }
    </script>

</body>

</html>
